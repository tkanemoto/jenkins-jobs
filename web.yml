#
# Website maintenance jobs
#
- defaults:
    name: web-defaults
    logrotate:
      numToKeep: 100

- job-template:
    name: 'web-maintenance-{name}'
    display-name: 'Web Maintenance - {name}'
    node: '{name}'
    defaults: web-defaults

    triggers:
      - timed: '{trigger}'

    builders:
      - shell: |
          #!/bin/bash -ex
          cd /var/www/django-site/site
          source ../.virtualenv/bin/activate
          echo '
          from portfolios.models import *
          for p in Page.objects.all(): print(p.slug + " " + p.domain)

          ' | ./manage.py shell --settings project.settings_local | while read line ; do
            slug=`echo $line | cut -d ' ' -f1`
            domain=`echo $line | cut -d ' ' -f2`
            curl https://tkanemoto.com/portfolios/$slug/ > $WORKSPACE/$slug.html
            sudo cp $WORKSPACE/$slug.html static/index.html

            echo "
          from settings_local import *
          AWS_STORAGE_BUCKET_NAME = '$domain'
          AWS_AUTO_CREATE_BUCKET = True
          AWS_S3_OBJECT_PARAMETERS['CacheControl'] = 'max-age=86400'
          AWS_QUERYSTRING_EXPIRE = 86400
          " | sudo dd of=project/temp.py

            ./manage.py collectstatic --noinput --settings project.temp
          done
          sudo rm static/index.html
          sudo rm project/temp.py

          ./manage.py collectstatic --noinput --settings project.settings_local
          ./manage.py dumpdata --indent 2 --settings project.settings_local > $WORKSPACE/dump.json

    publishers:
      - email:
          recipients: '{recipients}'

      - archive:
          artifacts: '*'
          allow-empty: 'true'
          fingerprint: true
